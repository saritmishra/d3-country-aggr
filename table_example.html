<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
  <head>
    <style type="text/css">
      tr:nth-child(even) {background: #CCC}
      tr:nth-child(odd) {background: #FFF}
    </style>
  </head>
  <body>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script>

    var defaultColumns = ["name", "continent", "gdp", "life_expectancy", "population", "year"];
      var init = function(){
        var table = d3.select("body").append("table");
        table.append("thead").attr("class", "thead").append("tr");
        table.append("tbody");
        table.append("caption")
          .html("World Countries Ranking");
      };

      var prepareData = function(rawData){
        var yearLevelRows = [];
        rawData.forEach(function(country){ // each country object
          country.years.forEach(function(year){ //each country-year object
            yearLevelRows.push({
              "name": country.name,
              "continent": country.continent,
              "gdp": year.gdp,
              "life_expectancy": year.life_expectancy,
              "population": year.population,
              "year": year.year
            });
          });
        });
        return yearLevelRows;
      };

      var originalJson = [];
      d3.json("data/countries_1995_2012.json", function(error, data){
          originalJson = prepareData(data);
          init();
          buildTable(defaultColumns, originalJson);
      });

      var filterByContinent = function() {
        var continents = [];
        d3.selectAll("input").each(function(d) { //Find all the selected continents
          if(d3.select(this).attr("type") == "checkbox" && d3.select(this).node().checked) {
            continents.push(d3.select(this).attr("name"));
          }
        });

        if (continents.length != 0) { //show filtered data only if a checkbox is selected
          var filteredJSON = [];
          originalJson.forEach(function(elm){
            if (continents.indexOf(elm.continent) != -1) // if elm.continent is one of the selected continents
              filteredJSON.push(elm);
          });
          buildTable(defaultColumns, filteredJSON);
        }
        else  {
          buildTable(defaultColumns, originalJson); // If no checkbox is selected, show all data
        }
      };

      var doAggregation = function(aggregateBy){
        if (!aggregateBy) {
          filterByContinent();
        }
        else {
          var aggregatedRows = d3.nest()
            .key(function(d){ return d[aggregateBy]; })
            // .key(function(d){ return d["year"]; }) //secondary grouping on year
            .rollup(function(leaves, i){
              return {
                // name, continent, gdp, life_expectancy, population, year
                name: leaves[0][aggregateBy], // grab the continent value from the first array element
                population: d3.sum(leaves, function(x){ return +x.population; }),
                gdp: d3.sum(leaves, function(x){ return +x.gdp; }),
                life_expectancy: d3.min(leaves, function(x){ return +x.life_expectancy; }),
                year: leaves[0].year,
                continent: leaves[0].continent
              };
            })
            .map(originalJson, d3.map); // This is IMPORTANT. Because of this, I can directly use map.values()

          buildTable(defaultColumns, aggregatedRows.values());
        };
      };

      var buildTable = function (columns, data){
        var headerRow = d3.select("thead>tr");
        var tbody = d3.select("tbody");

        // Remove all existing rows and start from scratch!
        headerRow.selectAll("th").remove();
        tbody.selectAll("tr.row").remove();

        var sortToggle = true;
        headerRow.selectAll("th")
          .data(columns) // adding the header row with columns[]
        .enter()
          .append("th")
          .text(function(d) { return d; })
          .on("click", function(header, i) { //sort functionality on click.
            sortToggle = !sortToggle;
            tbody.selectAll("tr").sort(function(a, b) {
              if (a[header] === b[header]) // To resolve conflicts, secondary sort on name
                  return d3.ascending(a["name"], b["name"]);

              if (typeof(a[header]) === "string")
                return sortToggle ? d3.descending(a[header], b[header]) : d3.ascending(a[header], b[header]);

              if (typeof(a[header]) === "number"){
                return sortToggle ? a[header] - b[header] : b[header] - a[header];
              }
            });
          });

        var rows = tbody.selectAll("tr.row")
            .data(data)
            .enter()
            .append("tr").attr("class", "row");

        var cells = rows.selectAll("td")
          .data(function(row) { // row is referring to the object that is already bound to the selection
              return d3.range(columns.length).map(function(d, i){
                // FORMATTING NUMBERS
                if (columns[i] == "life_expectancy")
                  return d3.round(row["life_expectancy"],1);

                if (columns[i] == "population") {
                  var format = d3.format(",");
                  return format(row["population"]);
                }

                if (columns[i] == "gdp") {
                  return d3.format("4.1s")(row["gdp"]);
                }

                return row[columns[i]];
              });
              // return d3.range(Object.keys(row).length).map(function(column, i) {
              //     return row[Object.keys(row)[i]];
              // });
          });

          cells
            .enter()
            .append("td")
            .text(function(d) {
              return d;
            });
        };
    </script>

    <label>Americas
      <input type="checkbox" name="Americas" value="Americas" title="Americas" onchange="filterByContinent();">
      </input>
    </label>
    <label>Africa
      <input type="checkbox" name="Africa" value="Africa" title="Africa" onchange="filterByContinent();">
      </input>
    </label>
    <label>Asia
      <input type="checkbox" name="Asia" value="Asia" title="Asia" onchange="filterByContinent();">
      </input>
    </label>
    <label>Europe
      <input type="checkbox" name="Europe" value="Europe" title="Europe" onchange="filterByContinent();">
      </input>
    </label>
    <label>Oceania
      <input type="checkbox" name="Oceania" value="Oceania" title="Oceania" onchange="filterByContinent();">
      </input>
    </label>

    Aggregation:
    <label>None
      <input type="radio" class="aggregation" name="None" value="None" onclick="doAggregation();" checked>
      </input>
    </label>
    <label>by Continent
      <input type="radio" class="aggregation" name="None" value="None" onclick="doAggregation('continent');">
      </input>
    </label>

  </body>
</html>